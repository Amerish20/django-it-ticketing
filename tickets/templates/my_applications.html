
{% extends 'base.html' %}
{% block title %}My Applications{% endblock %}

{% block content %}
{% include 'partials/_dashboard_apply_modal.html' %}
<style>
  .no-break {
  white-space: nowrap;
  word-break: keep-all;
}
.wrap-text {
  white-space: normal;      /* allow wrapping */
  word-break: break-word;   /* break long words if needed */
  overflow-wrap: break-word; /* modern alternative */
}

</style>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0"><i class="fas fa-calendar-check text-primary"></i> My Applications</h3>
    </div>

     <!-- Filter Section -->
    <div class="card shadow-sm mb-6">
      <div class="card-body">
        <form class="form-row" id="filterForm">
          <!-- Request Type -->
          <div class="form-group col-md-4">
            <label for="filterRequestForm">Request Type</label>
            <select id="filterRequestForm" class="form-control">
              <option value="" disabled selected>Select Request Type</option>
              {% for rf in request_forms %}
                <option value="{{ rf.id }}">{{ rf.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Leave Type (only when Request=Leave) -->
          <div class="form-group col-md-4" id="leaveTypeFilterWrapper" style="display:none;">
            <label for="filterLeaveType">Leave Type</label>
            <select id="filterLeaveType" class="form-control">
             <option value="" disabled selected>Select Leave Type</option>
              {% for lt in leave_types %}
                <option value="{{ lt.id }}">{{ lt.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Status -->
          <div class="form-group col-md-4">
            <label for="filterStatus">Status</label>
            <select id="filterStatus" class="form-control">
              <option value="" disabled selected>Select Status</option>
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
        </form>
      </div>
    </div>
    {# Leave table #}
    <div class="table-responsive" id="applicationsTableWrapper" style="display: none;">
        <table class="table table-hover table-bordered shadow-sm" id="applicationsTable">
            <thead class="thead-light">
                <tr>
                    <th>#</th>
                    <th>App Id</th>
                    <th>Request Type</th>
                    <th>Leave Type</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Total Days</th>
                    <th>Status</th>
                    <th>Remarks</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for app in applications %}
                <tr class="no-break">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ app.application_id }}</td>
                    <td>{{ app.request_form.name }}</td>
                    <td>
                    {% if app.leave_type %}
                        {{ app.leave_type.name }}
                    {% else %}
                        -
                    {% endif %}
                    </td>
                    <td>{{ app.from_date }}</td>
                    <td>{{ app.to_date }}</td>
                    <td>{{ app.total_days }}</td>
                    <td>
                    {# ✅ Pending Flow #}
                    {% if app.dep_head_status == "Pending" and app.hr_status == "Pending" and app.gm_status == "Pending" %}
                        <span class="badge badge-warning">Pending by Dep Head</span>
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Pending" and app.gm_status == "Pending" %}
                        <span class="badge badge-warning">Pending by HR</span>
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Approved" and app.gm_status == "Pending" %}
                        <span class="badge badge-warning">Pending by RM</span>

                    {# ✅ Rejected Flow #}
                    {% elif app.dep_head_status == "Rejected" %}
                        <span class="badge badge-danger">Rejected by Dep Head</span>
                    {% elif app.hr_status == "Rejected" %}
                        <span class="badge badge-danger">Rejected by HR</span>
                    {% elif app.gm_status == "Rejected" %}
                        <span class="badge badge-danger">Rejected by RM</span>

                    {# ✅ Approved Flow #}
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Approved" and app.gm_status == "Approved" %}
                        <span class="badge badge-success">Approved by RM</span>
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Approved" %}
                        <span class="badge badge-success">Approved by HR</span>
                    {% elif app.dep_head_status == "Approved" %}
                        <span class="badge badge-success">Approved by Dep Head</span>

                    {# Fallback #}
                    {% else %}
                        <span class="badge badge-secondary">Unknown</span>
                    {% endif %}
                    </td>
                    <td class="wrap-text">{{ app.remarks }}</td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">
                            {% if app.dep_head_status == 'Pending' %}
                            <button class="btn btn-sm btn-outline-warning" onclick="openEditModal({{ app.id }})" title="Edit">
                            <i class="fas fa-edit"></i>
                            </button>&nbsp;
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteApplication({{ app.id }})" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                            </button>&nbsp;
                            {% endif %}
                            <button class="btn btn-sm btn-outline-success" onclick="downloadApplication({{ app.id }}, '{{ app.application_id }}',{{ app.request_form.id }})" title="Download">
                              <i class="fas fa-download"></i>
                            </button>&nbsp;
                            <!-- Print -->
                            {% comment %} <button class="btn btn-sm btn-outline-primary" onclick="printApplication({{ app.id }}, '{{ app.application_id }}',{{ app.request_form.id }})" title="Print">
                                <i class="fas fa-print"></i>
                            </button> {% endcomment %}
                        </div>
                        
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {# Rejoining table #}
     <div class="table-responsive" id="applicationsTableWrapper_rejoin" style="display: none;">
        <table class="table table-hover table-bordered shadow-sm" id="applicationsTable_rejoin">
            <thead class="thead-light">
                <tr>
                    <th>#</th>
                    <th>App Id</th>
                    <th>Request Type</th>
                    <th style="display: none;">Type</th>
                    <th>From-</th>
                    <th>To</th>
                    <th>Rejoin Date</th>
                    <th>Delayed Days</th>
                    <th>Total Days</th>
                    <th>Status</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for app in applications %}
                <tr class="no-break">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ app.application_id }}</td>
                    <td>{{ app.request_form.name }}</td>
                    <td style="display: none;">
                    {% if app.leave_type %}
                        {{ app.leave_type.name }}
                    {% else %}
                        -
                    {% endif %}
                    </td>
                    <td>{{ app.from_date }}</td>
                    <td>{{ app.to_date }}</td>
                    <td>{{ app.rejoin_date }}</td>
                    <td>{{ app.delayed_days }}</td>
                    <td>{{ app.total_days_after_rejoin }}</td>
                    <td>
                    {# ✅ Pending Flow #}
                    {% if app.dep_head_status == "Pending" and app.hr_status == "Pending" and app.gm_status == "Pending" %}
                        <span class="badge badge-warning">Pending by Dep Head</span>
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Pending" and app.gm_status == "Pending" %}
                        <span class="badge badge-warning">Pending by HR</span>
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Approved" and app.gm_status == "Pending" %}
                        <span class="badge badge-warning">Pending by RM</span>

                    {# ✅ Rejected Flow #}
                    {% elif app.dep_head_status == "Rejected" %}
                        <span class="badge badge-danger">Rejected by Dep Head</span>
                    {% elif app.hr_status == "Rejected" %}
                        <span class="badge badge-danger">Rejected by HR</span>
                    {% elif app.gm_status == "Rejected" %}
                        <span class="badge badge-danger">Rejected by RM</span>

                    {# ✅ Approved Flow #}
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Approved" and app.gm_status == "Approved" %}
                        <span class="badge badge-success">Approved by RM</span>
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Approved" %}
                        <span class="badge badge-success">Approved by HR</span>
                    {% elif app.dep_head_status == "Approved" %}
                        <span class="badge badge-success">Approved by Dep Head</span>

                    {# Fallback #}
                    {% else %}
                        <span class="badge badge-secondary">Unknown</span>
                    {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">
                            {% if app.dep_head_status == 'Pending' %}
                            <button class="btn btn-sm btn-outline-warning" onclick="openEditModal({{ app.id }})" title="Edit">
                            <i class="fas fa-edit"></i>
                            </button>&nbsp;
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteApplication({{ app.id }})" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                            </button>&nbsp;
                            {% endif %}
                            <button class="btn btn-sm btn-outline-success" onclick="downloadApplication({{ app.id }}, '{{ app.application_id }}',{{ app.request_form.id }})" title="Download">
                              <i class="fas fa-download"></i>
                            </button>&nbsp;
                            <!-- Print -->
                            {% comment %} <button class="btn btn-sm btn-outline-primary" onclick="printApplication({{ app.id }}, '{{ app.application_id }}',{{ app.request_form.id }})" title="Print">
                                <i class="fas fa-print"></i>
                            </button> {% endcomment %}
                        </div>
                        
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {# Salary Advance table #}
    <div class="table-responsive" id="applicationsTableWrapper_salary_ad" style="display: none;">
        <table class="table table-hover table-bordered shadow-sm" id="applicationsTable_salary_ad">
            <thead class="thead-light">
                <tr>
                    <th>#</th>
                    <th>App Id</th>
                    <th>Request Type</th>
                    <th style="display: none;">Type</th>
                    <th>Month</th>
                    <th>Year</th>
                    <th>Status</th>
                    <th>Remarks</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for app in applications %}
                <tr class="no-break">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ app.application_id }}</td>
                    <td>{{ app.request_form.name }}</td>
                    <td style="display: none;">
                    {% if app.leave_type %}
                        {{ app.leave_type.name }}
                    {% else %}
                        -
                    {% endif %}
                    </td>
                    <td>{{ app.salary_ad_month }}</td>
                    <td>{{ app.salary_ad_year }}</td>
                    <td>
                    {# ✅ Pending Flow #}
                    {% if app.dep_head_status == "Pending" and app.hr_status == "Pending" and app.gm_status == "Pending" %}
                        <span class="badge badge-warning">Pending by Dep Head</span>
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Pending" and app.gm_status == "Pending" %}
                        <span class="badge badge-warning">Pending by HR</span>
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Approved" and app.gm_status == "Pending" %}
                        <span class="badge badge-warning">Pending by RM</span>

                    {# ✅ Rejected Flow #}
                    {% elif app.dep_head_status == "Rejected" %}
                        <span class="badge badge-danger">Rejected by Dep Head</span>
                    {% elif app.hr_status == "Rejected" %}
                        <span class="badge badge-danger">Rejected by HR</span>
                    {% elif app.gm_status == "Rejected" %}
                        <span class="badge badge-danger">Rejected by RM</span>

                    {# ✅ Approved Flow #}
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Approved" and app.gm_status == "Approved" %}
                        <span class="badge badge-success">Approved by RM</span>
                    {% elif app.dep_head_status == "Approved" and app.hr_status == "Approved" %}
                        <span class="badge badge-success">Approved by HR</span>
                    {% elif app.dep_head_status == "Approved" %}
                        <span class="badge badge-success">Approved by Dep Head</span>

                    {# Fallback #}
                    {% else %}
                        <span class="badge badge-secondary">Unknown</span>
                    {% endif %}
                    </td>
                    <td class="wrap-text">{{ app.remarks }}</td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">
                            {% if app.dep_head_status == 'Pending' %}
                            <button class="btn btn-sm btn-outline-warning" onclick="openEditModal({{ app.id }})" title="Edit">
                            <i class="fas fa-edit"></i>
                            </button>&nbsp;
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteApplication({{ app.id }})" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                            </button>&nbsp;
                            {% endif %}
                            <button class="btn btn-sm btn-outline-success" onclick="downloadApplication({{ app.id }}, '{{ app.application_id }}',{{ app.request_form.id }})" title="Download">
                              <i class="fas fa-download"></i>
                            </button>&nbsp;
                            <!-- Print -->
                            {% comment %} <button class="btn btn-sm btn-outline-primary" onclick="printApplication({{ app.id }}, '{{ app.application_id }}',{{ app.request_form.id }})" title="Print">
                                <i class="fas fa-print"></i>
                            </button>  {% endcomment %}
                        </div>
                        
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editApplicationModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg" id="editApplicationContent">
            <!-- Modal content loaded by AJAX -->
        </div>
    </div>
</div>

{% if messages %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      {% for message in messages %}
        Swal.fire({
          icon: '{{ message.tags }}',  // success, error, warning, info
          title: '{{ message.tags|title }}',
          text: '{{ message|escapejs }}',
          timer: 3000,
          showConfirmButton: false
        });
      {% endfor %}
    });
  </script>
{% endif %}

<script>
/* ---------- helper: parse date robustly ---------- */
function parseDateFlexible(val) {
  if (!val) return null;
  // YYYY-MM-DD
  if (val.indexOf('-') !== -1) {
    const parts = val.split('-').map(s => s.trim());
    if (parts.length === 3) {
      const y = parseInt(parts[0], 10),
            m = parseInt(parts[1], 10) - 1,
            d = parseInt(parts[2], 10);
      return new Date(y, m, d);
    }
  }
  // MM/DD/YYYY
  if (val.indexOf('/') !== -1) {
    const parts = val.split('/').map(s => s.trim());
    if (parts.length === 3) {
      const m = parseInt(parts[0], 10) - 1,
            d = parseInt(parts[1], 10),
            y = parseInt(parts[2], 10);
      return new Date(y, m, d);
    }
  }
  // fallback
  const dt = new Date(val);
  return isNaN(dt) ? null : dt;
}

/* ---------- calculates inclusive day count ---------- */
function calculateDaysBetween(fromVal, toVal) {
  const fromDate = parseDateFlexible(fromVal);
  const toDate = parseDateFlexible(toVal);
  if (!fromDate || !toDate || isNaN(fromDate) || isNaN(toDate)) return null;
  if (toDate < fromDate) return null;
  const diff = Math.floor((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
  return diff > 0 ? diff : null;
}

/* ---------- setup function called AFTER modal HTML is injected ---------- */
function setupTotalDaysCalculator() {

  // query inside modal content to avoid picking other inputs on page
  const modalRoot = document.getElementById('editApplicationContent');
  if (!modalRoot) { console.error('[TD] modal root not found'); return; }

  const fromInput = modalRoot.querySelector('input[name="from_date"]');
  const toInput   = modalRoot.querySelector('input[name="to_date"]');
  const totalDaysInput = modalRoot.querySelector('#total_days');

  if (!fromInput || !toInput || !totalDaysInput) {
    return;
  }

  /* ----------- set min date = first day of previous month ----------- */
  const today = new Date();
  const prevMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
  const year = prevMonth.getFullYear();
  const month = String(prevMonth.getMonth() + 1).padStart(2, '0');
  const day = '01';
  const minDate = `${year}-${month}-${day}`;

  fromInput.setAttribute('min', minDate);
  toInput.setAttribute('min', minDate);

  // avoid attaching listeners twice to the same element
  if (fromInput.dataset.tdAttached === '1' || toInput.dataset.tdAttached === '1') {
  } else {
    const handler = function () {
      const days = calculateDaysBetween(fromInput.value, toInput.value);
      if (days === null) {
        totalDaysInput.value = '';
      } else {
        totalDaysInput.value = days;
      }
    };

    // conservative set of events to catch both native and typing/datepicker changes
    ['change','input','keyup','blur'].forEach(ev => {
      fromInput.addEventListener(ev, handler);
      toInput.addEventListener(ev, handler);
    });

    // If jQuery and bootstrap/jQuery datepicker used, also bind their events
    if (window.jQuery) {
      try {
        const $from = window.jQuery(fromInput);
        const $to   = window.jQuery(toInput);
        // jQuery UI datepicker / common event
        $from.on('change', handler);
        $to.on('change', handler);
        // bootstrap-datepicker's event
        $from.on('changeDate', handler);
        $to.on('changeDate', handler);
      } catch (err) {

      }
    }

    // mark attached so we don't double-attach if called again
    fromInput.dataset.tdAttached = '1';
    toInput.dataset.tdAttached = '1';
  }

  // initial calculation (immediately show initial total_days)
  const initial = calculateDaysBetween(fromInput.value, toInput.value);
  if (initial === null) {
    totalDaysInput.value = totalDaysInput.value || ''; // keep whatever server sent or blank
  } else {
    totalDaysInput.value = initial;
  }
}

/* ---------- open modal: fetch HTML then inject & setup ---------- */
function openEditModal(appId) {
  fetch(`/edit-application/${appId}/`)
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.text();
    })
    .then(html => {
      document.getElementById('editApplicationContent').innerHTML = html;
      // show bootstrap modal (v4/v5 compatible)
      const $modal = window.jQuery ? window.jQuery('#editApplicationModal') : null;
      if ($modal && typeof $modal.modal === 'function') {
        $modal.modal('show');
      } else if (typeof bootstrap !== 'undefined') {
        const modalEl = document.getElementById('editApplicationModal');
        new bootstrap.Modal(modalEl).show();
      } else {
        // fallback: just make it visible
        document.getElementById('editApplicationModal').classList.add('show');
      }

      // small timeout to ensure DOM insertion done (often immediate but safe)
      setTimeout(setupTotalDaysCalculator, 10);
    })
    .catch(err => {
    });
}

// Edit section
$(document).on("click", "#editSave", function() {
    const form = $("#editApplicationForm")[0];
    const applicationId = form.querySelector('input[name="application_id"]').value;

    if (!form.checkValidity()) {
      form.reportValidity();   // shows built-in messages
      return;                  // stop — don't run AJAX
    }

    $.ajax({
        url: `/edit-application/${applicationId}/`,
        type: "POST",
        data: $(form).serialize(),
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    icon: "success",
                    title: "Updated!",
                    text: "Application has been updated successfully.",
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    $('#editApplicationModal').modal('hide');  // hide modal after success
                    location.reload();  // reload page or update UI as needed
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: response.error || "Something went wrong."
                });
            }
        },
        error: function() {
            Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "Server error occurred."
            });
        }
    });
});

//Delete section
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteApplication(appId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "Do you want to permanently delete this application?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/delete-application/${appId}/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(data) {
                    if (data.success) {
                        Swal.fire(
                            'Deleted!',
                            'Application has been permanently deleted.',
                            'success'
                        ).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error!', data.error || 'Failed to delete.', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Error!', 'Server error occurred.', 'error');
                }
            });
        }
    });
}

function downloadApplication(appId, applicationId,reqId) {
     fetch(`/download-application/${appId}/${reqId}/`, {
        method: "GET"
    })
    .then(response => {
        if (!response.ok) throw new Error("Download failed");
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Application_${applicationId}.pdf`;  // use applicationId in filename
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    })
    .catch(err => console.error(err));
}

function printApplication(appId, applicationId,reqId) {
    // Open print view in new tab (Django view should return a PDF or print-friendly HTML)
    window.open(`/application-print/${appId}/${reqId}/`, '_blank');
}


document.addEventListener("DOMContentLoaded", function() {
  const reqFilter = document.getElementById("filterRequestForm");
  const leaveFilter = document.getElementById("filterLeaveType");
  const statusFilter = document.getElementById("filterStatus");
  const leaveWrapper = document.getElementById("leaveTypeFilterWrapper");

  const leaveTableWrapper = document.getElementById("applicationsTableWrapper");
  const rejoinTableWrapper = document.getElementById("applicationsTableWrapper_rejoin");
  const salaryadvanceWrapper = document.getElementById("applicationsTableWrapper_salary_ad");

  const leaveTbody = document.querySelector("#applicationsTable tbody");
  const rejoinTbody = document.querySelector("#applicationsTable_rejoin tbody");
  const salaryadvancTbody = document.querySelector("#applicationsTable_salary_ad tbody");

  // Store original rows
  const originalLeaveRows = Array.from(leaveTbody.querySelectorAll("tr"));
  const originalRejoinRows = Array.from(rejoinTbody.querySelectorAll("tr"));
  const originalSalaryRows = Array.from(salaryadvancTbody.querySelectorAll("tr"));

  // Map Request Type ID -> its Leave Types
  const leaveTypesMap = {
    {% for rf in request_forms %}
      "{{ rf.id }}": [
        {% for lt in leave_types %}
          {% if lt.request_form.id == rf.id %} {id: "{{ lt.id }}", name: "{{ lt.name }}"}, {% endif %}
        {% endfor %}
      ],
    {% endfor %}
  };

  function updateLeaveOptions() {
    const selectedReq = reqFilter.value;
    leaveFilter.innerHTML = '<option value="" disabled selected>Select Leave Type</option>';

    if (selectedReq && leaveTypesMap[selectedReq]?.length) {
      leaveWrapper.style.display = "block";
      leaveTypesMap[selectedReq].forEach(lt => {
        const option = document.createElement("option");
        option.value = lt.id;
        option.text = lt.name;
        leaveFilter.appendChild(option);
      });
    } else {
      leaveWrapper.style.display = "none";
    }
  }

  function showNoDataMessage(tbody) {
    tbody.innerHTML = '<tr><td colspan="100%" class="text-center text-muted">No data available</td></tr>';
  }

  function applyFilters() {
    const reqVal = reqFilter.value;
    const leaveVal = leaveFilter.value;
    const statusVal = statusFilter.value.toLowerCase();

    if (!reqVal) {
      leaveWrapper.style.display = "none";
      leaveTableWrapper.style.display = "none";
      rejoinTableWrapper.style.display = "none";
      salaryadvanceWrapper.style.display = "none";
      return;
    }

    if (reqVal == "1") { // Leave
      leaveWrapper.style.display = "block";
      leaveTableWrapper.style.display = "block";
      rejoinTableWrapper.style.display = "none";
      salaryadvanceWrapper.style.display = "none";

      leaveTbody.innerHTML = ""; // clear tbody
      let anyVisible = false;

      originalLeaveRows.forEach(row => {
        const rowRequestType = row.querySelector("td:nth-child(3)").innerText.trim().toLowerCase(); 
        const rowLeave = row.querySelector("td:nth-child(4)").innerText.trim();
        const rowStatus = row.querySelector("td:nth-child(8)").innerText.toLowerCase();
        let show = true;
        // Only include rows where request type is "leave"
        if (rowRequestType !== "leave") show = false;
        if (leaveVal && rowLeave !== leaveFilter.options[leaveFilter.selectedIndex].text) show = false;
        if (statusVal && !rowStatus.includes(statusVal)) show = false;
        if (show) {
          leaveTbody.appendChild(row);
          anyVisible = true;
        }
      });

      if (!anyVisible) showNoDataMessage(leaveTbody);

    } else if (reqVal == "2") { // Rejoining
      leaveWrapper.style.display = "none";
      leaveTableWrapper.style.display = "none";
      salaryadvanceWrapper.style.display = "none";
      rejoinTableWrapper.style.display = "block";

      rejoinTbody.innerHTML = ""; // clear tbody
      let anyVisible = false;

      originalRejoinRows.forEach(row => {
        const rowRequestType = row.querySelector("td:nth-child(4)").innerText.trim().toLowerCase();
        const rowStatus = row.querySelector("td:nth-child(10)").innerText.toLowerCase();
        let show = true;
         // Only include rows where request type is "rejoining"
        if (rowRequestType !== "rejoining") show = false;
        if (statusVal && !rowStatus.includes(statusVal)) show = false;
        if (show) {
          rejoinTbody.appendChild(row);
          anyVisible = true;
        }
      });

      if (!anyVisible) showNoDataMessage(rejoinTbody);

    } 
    else if (reqVal == "3") { // Salary Advance
      leaveWrapper.style.display = "none";
      leaveTableWrapper.style.display = "none";
      rejoinTableWrapper.style.display = "none";
      salaryadvanceWrapper.style.display = "block";
      

      salaryadvancTbody.innerHTML = ""; // clear tbody
      let anyVisible = false;

      originalSalaryRows.forEach(row => {
        const rowRequestType = row.querySelector("td:nth-child(4)").innerText.trim().toLowerCase();
        const rowStatus = row.querySelector("td:nth-child(7)").innerText.toLowerCase();
        let show = true;
         // Only include rows where request type is "salary advance"
        if (rowRequestType !== "salary advance") show = false;
        if (statusVal && !rowStatus.includes(statusVal)) show = false;
        if (show) {
          salaryadvancTbody.appendChild(row);
          anyVisible = true;
        }
      });

      if (!anyVisible) showNoDataMessage(salaryadvancTbody);

    } 
    else {
      leaveWrapper.style.display = "none";
      leaveTableWrapper.style.display = "none";
      rejoinTableWrapper.style.display = "none";
      salaryadvanceWrapper.style.display = "none";
    }
  }

  reqFilter.addEventListener("change", function() {
    updateLeaveOptions();
    applyFilters();
  });
  leaveFilter.addEventListener("change", applyFilters);
  statusFilter.addEventListener("change", applyFilters);

  updateLeaveOptions();
  applyFilters();
});
</script>

{% endblock %}
